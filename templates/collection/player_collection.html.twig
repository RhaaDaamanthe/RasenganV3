{% extends 'base.html.twig' %}

{% block title %}Collection de {{ user.pseudo }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/styles.css') }}">
{% endblock %}

{% block body %}
<main class="main-collec-responsive">

    <h2 id="Catalogue">Chez {{ user.pseudo }}</h2>

    <!-- Barre de recherche + filtres -->
    <div class="search-filters-container">
        <form method="get" action="" class="search-form">
            <div class="search-input-wrapper">
                <input 
                    type="text" 
                    name="search" 
                    id="searchbar" 
                    placeholder="Recherche un personnage, un anim√©, une s√©rie ou un film..." 
                    value="{{ search ?? '' }}"
                />
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="sectionFilter">üìö Section</label>
                    <select name="section" id="sectionFilter" onchange="this.form.submit()">
                        <option value="">Toutes les sections</option>
                        <option value="anime" {% if selectedSection == 'anime' %}selected{% endif %}>Anim√©s</option>
                        <option value="film" {% if selectedSection == 'film' %}selected{% endif %}>Films & s√©ries</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="rarityFilter">üåü Raret√©</label>
                    <select name="rarity" id="rarityFilter" onchange="this.form.submit()">
                        <option value="">Toutes les raret√©s</option>
                        {% for rarity in rarities %}
                            <option value="{{ rarity.libelle }}" {% if selectedRarity == rarity.libelle %}selected{% endif %}>
                                {{ rarity.libelle }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                {% if search or selectedRarity or selectedSection %}
                    <a href="{{ path(app.request.attributes.get('_route'), {'id': user.id}) }}" class="reset-filters">
                        ‚úñ R√©initialiser
                    </a>
                {% endif %}
            </div>

            <!-- üü£ Compteur styl√© int√©gr√© -->
            <div class="player-stats-inline">
                <span class="player-cards">üçú {{ user.userCardAnimes|length }} cartes Anime</span>
                <span class="player-cards">üé¨ {{ user.userCardFilms|length }} cartes Film</span>
            </div>
        </form>
    </div>


    <!-- Pagination (haut) -->
    {% if totalPages > 1 %}
        <div class="pagination pagination-top">
            {% if currentPage > 1 %}
                <a href="?page={{ currentPage - 1 }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}{% if selectedSection %}&section={{ selectedSection }}{% endif %}" class="pagination-btn prev">‚Üê Pr√©c√©dent</a>
            {% endif %}

            <div class="pagination-numbers">
                {% for i in 1..totalPages %}
                    {% if i == 1 or i == totalPages or (i >= currentPage - 2 and i <= currentPage + 2) %}
                        <a href="?page={{ i }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}{% if selectedSection %}&section={{ selectedSection }}{% endif %}"
                           class="page-number {% if i == currentPage %}active{% endif %}">
                            {{ i }}
                        </a>
                    {% elseif i == currentPage - 3 or i == currentPage + 3 %}
                        <span class="pagination-dots">...</span>
                    {% endif %}
                {% endfor %}
            </div>

            {% if currentPage < totalPages %}
                <a href="?page={{ currentPage + 1 }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}{% if selectedSection %}&section={{ selectedSection }}{% endif %}" class="pagination-btn next">Suivant ‚Üí</a>
            {% endif %}
        </div>
    {% endif %}

    <!-- Catalogue -->
    <div class="catalogue2">
        {% if paginatedCards is empty %}
            <div class="no-results">
                <p>üòî Aucune carte trouv√©e avec ces crit√®res.</p>
                {% if search or selectedRarity or selectedSection %}
                    <a href="{{ path(app.request.attributes.get('_route'), {'id': user.id}) }}">R√©initialiser les filtres</a>
                {% else %}
                    <p>{{ user.pseudo }} n'a aucune carte dans son inventaire.</p>
                {% endif %}
            </div>
        {% else %}
            {% for userCard in paginatedCards %}
                {% if userCard.cardAnime is defined and userCard.cardAnime is not null %}
                    {% set card = userCard.cardAnime %}
                    {% set section = 'anime' %}
                {% elseif userCard.cardFilm is defined and userCard.cardFilm is not null %}
                    {% set card = userCard.cardFilm %}
                    {% set section = 'film' %}
                {% else %}
                    {% set card = null %}
                {% endif %}

                {% if card is not null %}
                    <div class="card">
                        {% if card.imagePath %}
                            <img src="{{ asset(card.imagePath) }}" alt="{{ card.nom }}">
                        {% else %}
                            <img src="{{ asset('images/placeholder.png') }}" alt="{{ card.nom }}">
                        {% endif %}
                        <div class="card-content">
                            <h2 class="card-title">x{{ userCard.quantity }}</h2>
                            {% if card.description %}
                                <p>{{ card.description|raw }}</p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    <!-- Pagination (bas) -->
    {% if totalPages > 1 %}
        <div class="pagination pagination-bottom">
            {% if currentPage > 1 %}
                <a href="?page={{ currentPage - 1 }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}{% if selectedSection %}&section={{ selectedSection }}{% endif %}" class="pagination-btn prev">‚Üê Pr√©c√©dent</a>
            {% endif %}

            <div class="pagination-numbers">
                {% for i in 1..totalPages %}
                    {% if i == 1 or i == totalPages or (i >= currentPage - 2 and i <= currentPage + 2) %}
                        <a href="?page={{ i }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}{% if selectedSection %}&section={{ selectedSection }}{% endif %}" 
                           class="page-number {% if i == currentPage %}active{% endif %}">
                            {{ i }}
                        </a>
                    {% elseif i == currentPage - 3 or i == currentPage + 3 %}
                        <span class="pagination-dots">...</span>
                    {% endif %}
                {% endfor %}
            </div>

            {% if currentPage < totalPages %}
                <a href="?page={{ currentPage + 1 }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}{% if selectedSection %}&section={{ selectedSection }}{% endif %}" class="pagination-btn next">Suivant ‚Üí</a>
            {% endif %}
        </div>
    {% endif %}
</main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# PAS de filtre_cartes.js - tout est g√©r√© en PHP maintenant #}
    <script src="{{ asset('js/utilisateurs_cartes.js') }}"></script>
{% endblock %}