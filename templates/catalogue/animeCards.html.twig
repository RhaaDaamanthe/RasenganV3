{% extends 'base.html.twig' %}

{% block title %}
    {% if anime is defined %}
        Cartes de l'anim√© {{ anime.nom }}
    {% else %}
        Toutes les cartes
    {% endif %}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/styles.css') }}" />
    {# <link rel="stylesheet" href="{{ asset('css/catalogue.css') }}" /> #}
{% endblock %}

{% block body %}
    <main>
        <!-- Formulaire de recherche et filtres -->
        <div class="search-filters-container">
            <form method="get" action="" class="search-form">
                <div class="search-input-wrapper">
                    <input 
                        type="text" 
                        name="search" 
                        id="searchbar" 
                        placeholder="Recherche un personnage ou un anim√©..." 
                        value="{{ search ?? '' }}"
                    />
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <select name="rarity" id="rarityFilter" onchange="this.form.submit()">
                            <option value="">Toutes les raret√©s</option>
                            {% for rarity in rarities %}
                                <option value="{{ rarity.libelle }}" {% if selectedRarity == rarity.libelle %}selected{% endif %}>
                                    {{ rarity.libelle }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    {% if search or selectedRarity %}
                        <a href="{{ path(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')) }}" class="reset-filters">
                            ‚úñ R√©initialiser
                        </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- Pagination du haut -->
        {% if totalPages > 1 %}
            <div class="pagination pagination-top">
                {% if currentPage > 1 %}
                    <a href="?page={{ currentPage - 1 }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}" class="pagination-btn prev">
                        ‚Üê Pr√©c√©dent
                    </a>
                {% endif %}

                <div class="pagination-numbers">
                    {% for i in 1..totalPages %}
                        {% if i == 1 or i == totalPages or (i >= currentPage - 2 and i <= currentPage + 2) %}
                            <a href="?page={{ i }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}" 
                               class="page-number {% if i == currentPage %}active{% endif %}">
                                {{ i }}
                            </a>
                        {% elseif i == currentPage - 3 or i == currentPage + 3 %}
                            <span class="pagination-dots">...</span>
                        {% endif %}
                    {% endfor %}
                </div>

                {% if currentPage < totalPages %}
                    <a href="?page={{ currentPage + 1 }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}" class="pagination-btn next">
                        Suivant ‚Üí
                    </a>
                {% endif %}
            </div>
        {% endif %}

        <!-- Catalogue de cartes -->
        <div class="catalogue2">
            {% for card in cards %}
                {% if card.anime is not null %}
                    <div class="card" data-anime="{{ card.anime.nom }}" data-rarete="{{ card.rarity.libelle }}">
                        {% if card.imagePath %}
                            {% set is_webp = card.imagePath|last(5) == '.webp' %}
                            <picture>
                                <source 
                                    srcset="{{ asset(card.imagePath) }}" 
                                    type="{{ is_webp ? 'image/webp' : 'image/jpeg' }}"
                                >
                                <img 
                                    src="{{ asset(card.imagePath) }}" 
                                    alt="{{ card.nom }}"
                                >
                            </picture>
                        {% else %}
                            <img src="{{ asset('images/placeholder.png') }}" alt="{{ card.nom }}">
                        {% endif %}
                        
                        <div class="card-content">
                            {% set total_owned = 0 %}
                            {% for userCard in card.userCardAnimes %}
                                {% set total_owned = total_owned + userCard.quantity %}
                            {% endfor %}
                            
                            {% if card.rarity.id in [4, 5, 6] %}
                                <h2 class="card-title">
                                    {% if card.userCardAnimes|length > 0 and card.userCardAnimes|first.user is defined %}
                                        {{ card.userCardAnimes|first.user.pseudo }}
                                    {% else %}
                                        Aucun
                                    {% endif %}
                                </h2>
                            {% else %}
                                <h2 class="card-title">
                                    {{ total_owned }} / {{ card.quantity ?? 0 }}
                                </h2>

                                <ul class="owners-list" style="display:none;">
                                    {% if card.userCardAnimes|length > 0 %}
                                        {% for userCard in card.userCardAnimes %}
                                            <li>{{ userCard.user.pseudo }} (x{{ userCard.quantity }})</li>
                                        {% endfor %}
                                    {% else %}
                                        <li>Aucun propri√©taire</li>
                                    {% endif %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <div class="no-results">
                    <p>üòî Aucune carte trouv√©e avec ces crit√®res.</p>
                    <a href="{{ path(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')) }}">R√©initialiser les filtres</a>
                </div>
            {% endfor %}
        </div>

        <!-- Pagination du bas -->
        {% if totalPages > 1 %}
            <div class="pagination pagination-bottom">
                {% if currentPage > 1 %}
                    <a href="?page={{ currentPage - 1 }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}" class="pagination-btn prev">
                        ‚Üê Pr√©c√©dent
                    </a>
                {% endif %}

                <div class="pagination-numbers">
                    {% for i in 1..totalPages %}
                        {% if i == 1 or i == totalPages or (i >= currentPage - 2 and i <= currentPage + 2) %}
                            <a href="?page={{ i }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}" 
                               class="page-number {% if i == currentPage %}active{% endif %}">
                                {{ i }}
                            </a>
                        {% elseif i == currentPage - 3 or i == currentPage + 3 %}
                            <span class="pagination-dots">...</span>
                        {% endif %}
                    {% endfor %}
                </div>

                {% if currentPage < totalPages %}
                    <a href="?page={{ currentPage + 1 }}{% if search %}&search={{ search }}{% endif %}{% if selectedRarity %}&rarity={{ selectedRarity }}{% endif %}" class="pagination-btn next">
                        Suivant ‚Üí
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/utilisateurs_cartes.js') }}"></script>
{% endblock %}